faad 2.7 改造版 0.7

オープンソース (GPL) の AAC デコーダである FAAD にいくつか機能を追加し、
エラー耐性を強化したものです。

オリジナルとの主な違い
	・TS 中の AAC 読み込みに対応。
	・チャンネル変更点、サンプリングレート変更点で自動的に分割したwavを出力。
	・エラー出ても無音で埋めてスキップし極力継続する。
	・フレーム当たりのサンプル数を1024サンプルに固定（音ずれ対策）
	・-D XX でディレイ補正したwavを出力。
	　ディレイ補正は先頭のみの調整です。末尾は調整しないので全体の長さが変わります。
	・ファイル名に DELAY XXms でディレイ補正したwavを出力。
	・-E X:Y で指定した部分だけをデコード、取り出し
	・長時間のデコードで表示が止まるのを修正。
	・メッセージにフレーム番号を追加。

	TS 中の AAC の抽出、デコードに対応しました。
	MPEG2 ビデオストリームとのディレイ計算と限定的ですがPTS による
	ズレ補正に対応しています。
	読み込む AAC とディレイ計算の基準となる MPEG2 Video の決定に
	Program Association Table (PAT)/ Program Map Table (PMT) を利用します。
	プログラムの指定がない場合 PAT 上の最初のプログラムを読み込みます。
	それ以外を読み込む場合は --program オプションで指定してください。
	PAT/PMT を取り除いてある場合、最初に見つかった AAC と MPEG2 Video を読み込みますが、
	プログラムがひとつしかない場合でも PAT/PMT が存在していることが望ましいです。
	うまくいかない場合は --pid、 --video-pidで PID を直接指定してください。
	ビデオデコーダとして DGIndex を利用する場合は、--pts-base 3 を指定してください。
	(DGIndexはIフレームの前のBフレームを考慮してデコードされるため開始フレームが異なります。)
	一番最初のパケットから AAC を読み込むため、他のソフトよりディレイ値が小さくなりますが、
	出力はあっているはずです。

	オリジナルの FAAD 互換のため、最初のフレームを破棄する -E 1:0 をデフォルト値としてあります。
	デコードされた WAV としてはフレームを破棄しない -E 0:0 が正しいはずで、
	ディレイ値としては破棄した 1フレーム分の 21ms ズレている事になりますが、
	その後の FAAC 等でエンコードすると先頭に 1フレームが付加され
	延びるため、1フレーム分破棄してズラしておくと丁度合うようなのです。
	いずれにせよ、21ms は音源から 7m 離れた時の遅れ程度なので、
	問題になることはまず有りません。

	DGIndex で正常な AAC の抽出ができないものでも読み込めるものがあります。
	TS 処理は簡素に書いたので、まだ読めない TS があるかもしれません。
	分かればぼちぼち対応するかもしれません。

添付したバイナリは ダイナミックリンク版で libfaad2.dll が必要です。
libfaad2.dll は http://www.rarewares.org/aac-decoders.php より入手できます。
スタティックリンクしたものが欲しい場合は残りのソース入手してビルドしてください。

ソースコードは変更したもののみで全体は
http://www.audiocoding.com/faad2.html
から入手できます。



使用方法

faad [options] infile.aac

ファイル名
	ファイル名に "DELAY <X>ms" が含まれるとき、<X>msの無音が先頭に付加される。
	負の時は<X>ms除去される。TS ファイルでは無視される。
	大文字、小文字は区別されるので、"delay <X>ms"などでは動作しない。
	"DELAY <X>ms" の位置はファイル名末尾。(末尾でなくても動作するがスペース以降が切れる。)
	ファイルの種類の判別は拡張子によらないが、ファイル名には何らかの拡張子が付いていること。
	("..\infile" などは ".\infile" が拡張子とみなされ、"..wav" が出力される。)

オプション
	大文字小文字は区別される。改造版で追加したものは大文字にしている。

-h, --help
	ヘルプを表示し、終了する。

-i, --info
	入力ファイルの情報を表示し、出力せずに終了する。

-a, --adtsout <filename>
	MPEG-4 AAC ATDS を出力する。
	デコード結果を出力せずに入力ファイルの AAC フレームに ADTS ヘッダを付加して出力する。
	mp4 形式、AAC ADIF 形式、TS 形式の入力ファイルを AAC ADTS 形式に変換することが出来る。
	AAC ADTS ではバイパスされる。(オリジナルはヘッダが作り直される。)
	-S と共に使用でき、チャンネルが変化する部分で分割されたAACを出力できる。
	-E オプションに注意 (-E 0:0 が faad オリジナル互換)。

-t, --oldformat
	古い ADTS 形式を仮定する。
	8バイトの ADTS ヘッダであることをデコーダに伝える。

-o, --outfile <filename>
	デコード出力のファイル名を指定する。

-f, --format <X>
	デコード出力のファイル形式を設定する。有効な <X> の値は、
		1:Microsoft WAV format (default)
		2:RAW PCM data

-b, --bits <X>
	デコード出力のフォーマットを設定する。有効な <X> の値は、
		1:  16 bit PCM data (default).
		2:  24 bit PCM data.
		3:  32 bit PCM data.
		4:  32 bit floating point data.
		5:  64 bit floating point data.(注：未実装)
	5 はヘルプに記述されているが、実際には実装されていない模様。

-s, --samplerate <X>
	サンプリングレートを <X> にする。
	サンプリングレート情報のない RAW ファイルで用いられる。
	AAC ADTS、AAC ADIF、mp4 では、ヘッダの値が優先されるため、特に効果はない。
	デフォルト値は 44100 。
	(NeAACDecSetConfiguration に渡される。)

-S, --split 改造版のみ
	ADTS ヘッダの channel_configuration が変更されたとき、出力ファイルを切り替える。
	このオプションを指定していなくても 2ch → 5.1ch 等のデコードされるチャンネル数が
	変化する場合はWAV では 2ch と 5.1ch は共存できないため分割される。
	-d で　5.1ch を 2ch にダウンミックスすることで、分割を抑制できる。
	-a と共に使用でき、チャンネルが変化する部分で AAC ファイルを分割できる。

-l, --objecttype <X>
	AAC の オブジェクトタイプを指定する。利用出来るのは
		1:  Main object type.
		2:  LC (Low Complexity) object type.
		4:  LTP (Long Term Prediction) object type.
		23: LD (Low Delay) object type.
	AAC ADTS、AAC ADIF、mp4 では、ヘッダの値が優先されるため、特に効果はない。
	デフォルト値は 1 (Main) 。
	(NeAACDecSetConfiguration に渡される。)

-d, --downmix
	5.1ch を 2ch にダウンミックスして出力する。
	2ch → 5.1 ch のチャンネル変化でのファイル分割を抑制できる。

-D, --delay <X> 改造版のみ
	ディレイを ms 単位で指定する。
	ここで指定された長さの無音が先頭に付加される。負の時は除去される。
	ファイル名による指定より優先される。

-w (--stdio)
	デコード出力先を標準出力にする。
	WAV 形式ではヘッダを最後に書くため、シーク出来る必要がある。
	シークできない場合、RAW PCM (-f 2) を使用する必要がある。
	ロングオプション形式(--stdio) がギャップレスとかぶっている。

-g (--stdio)
	ギャップレスデコーディングを無効にする。
	mp4 コンテナの sample duration を無視する。
	mp4 コンテナでない場合(.aac)、特に効果はない。
	ロングオプション形式は無い(--stdioとなっている)。
	
-q, --quiet
	デコード中のメッセージ出力を抑制する。

-E, --extract <X>:<Y> 改造版のみ
	<X>フレームから <Y> - 1 フレームまでを出力する。<Y>に 0 を指定すると最後のフレームまで。
	フレーム番号は 0 からで 1 フレームはサンプリングレートによらず 1024 サンプル。
	ADTS AAC の場合はヘッダのフレーム長を見てデコードせずに飛ばし、指定フレームのみをデコー
	ドし出力する。ヘッダが破損しているときは次のシンクワードまでを 1 フレームとカウントして
	いるため、ヘッダが破損しているがデコードは正常に行われるとき番号がずれることがある。
	ADIF AAC の場合は指定フレーム前もデコードし、指定フレームから出力する。
	ディレイ調整とは独立に動作する。
	-a と共に使用でき、AACをデコードせずに一部を抜き出すことが出来る。
	デコード後の WAV が 4GB を超える場合や AAC のトリミング等に利用できる。
	mp4 コンテナでは動作しない(実装していない)。
	デフォルト値は 1:0 (オリジナル互換 最初のフレームを破棄し最後まで)
	例
		-E 0:3000
			0～2999フレーム目までの3000フレーム
		-E 1:3001
			1～3000フレーム目までの3000フレーム
		-E 3001:0
			3001フレーム目から最後まで

-F, --flags <X> 改造版のみ
	ファイルの分割方法等に関する細かな制御フラグを指定する。
	"実験的"オプション。

	チャンネル変化、サンプリングレート変化処理
		0x1: (default)
			'Unexpected channel configuration change' エラーでlibfaad2を再初期化する
		0x2: (-S)
			'Unexpected channel configuration change' エラーでファイル分割する

		0x4: (default)
			デコードされたチャンネル数が変化したとき、libfaad2を再初期化する。
		0x8: (default)
			デコードされたチャンネル数が変化したとき、ファイル分割する。
			AAC ADTS 出力 (-a) のときのみ無効に出来る。

		0x10: (-S)
			ADTS ヘッダのチャンネル構成が変化したとき、libfaad2を再初期化する。
		0x20: (-S)
			ADTS ヘッダのチャンネル構成が変化したとき、ファイル分割する。

		0x40:
			ADTS ヘッダのサンプリングレートが変化したとき、libfaad2を再初期化する。
		0x80: (-S)
			ADTS ヘッダのサンプリングレートが変化したとき、ファイル分割する。

	エラー処理
		0x100: (default)
			エラーフレームでlibfaad2を再初期化する
		0x200: (default)
			エラーフレームを無音として出力する。
			AAC ADTS 出力 (-a) の時はエラーフレーム。
		0x400:
			エラーフレームの前でファイルを分割する。
		0x800:
			エラーフレームの後ろでファイルを分割する。

		0x1000: (default)
			ヘッダの破損したエラーフレームでlibfaad2を再初期化する
		0x2000: (default)
			ヘッダの破損したエラーフレームを無音として出力する。
			長さは飛ばしたバイト数とビットレートから推測する。
			AAC ADTS 出力 (-a) の時は実際に飛ばしたデータ。
		0x4000: (default)
			ヘッダの破損したエラーフレームの前でファイルを分割する。
			0x300 が指定されているときは強制的に ON
		0x8000: (default)
			ヘッダの破損したエラーフレームの後ろでファイルを分割する。
			0x400 が指定されているときは強制的に ON

	その他
		0x10000:
			デコーダの初期化時に破棄される最初のフレームを強制的に読み出す。
			0フレーム目、もしくは再初期化後のフレームは 0 サンプルとして返ってくるが、
			ポインタも有効でデータが含まれるため、無音でパディングにする代わりに読みだしてみる。
		0x20000:
			Windowsのコンソールタイトルの出力を抑制する。
		0x30000:
			TS の PTS 調整のため無音を挿入する。

	デフォルト値は 0x3F30D
	-S を指定すると0x3F3BF
	例
		-d -F 0x3330D
			ほぼすべての場合ファイルは分割されずに出力される。
			5.1ch は 2ch になり、エラーは無音になる。
		-F 0x1115 -E 0:0 -a <filename>
			AAC からエラーフレーム、破損部分を取り除く。

TS 処理用オプション 改造版のみ
--program <X>
	読み込むプログラム番号を指定する。
	このオプションを指定するときは PAT/PMT が存在している必要がある。
	指定されていないときは PAT で最初のプログラムが読み込まれる。

--stream <X>
	プログラムに複数の AAC が含まれるとき <X> 番目(最初は1)の AAC を読み込む。
	デフォルト値は 1

-P, --pid <X>
	読み込む AAC の PID を直接指定する。
	16進数のの場合、先頭に0xを付ける。
	指定がない場合、PAT/PMT が存在すれば PAT/PMT から決定され、
	存在しない場合は最初に見つかったものを用いる。

--video-pid <X>
	ディレイ計算に用いる MPEG2 Video の PID を直接指定する。
	16進数のの場合、先頭に0xを付ける。
	指定がない場合、PAT/PMT が存在すれば PAT/PMT から決定され、
	存在しない場合は最初に見つかったものを用いる。

--pts-base <X>
	ディレイ計算に用いる同期点を指定する。有効な <X> の値は
		0:	最初の PES パケット (最初のフレーム)
		1:	最初の GOP の最初のフレーム (default)
		2:	最初の GOP の最初の B フレーム
		3:	最初の GOP の最初の B フレームに相当する値を I フレームと fps から計算する (DGIndex 互換)
		4:	最初の I フレーム
	同期したい MPEG2 ビデオデコーダーが出力する最初のフレームを指定する。
	通常は最初の GOP の I フレームから出力されるので、デフォルトの 1。
	DGIndex では I フレームの前の B フレームに相当するナルフレームが挿入されるので、
	3 を指定する。2 と 3 は算出方法が異なるだけで同じ値となる。
	4 は通常の GOP では 1 と同じだが、GOP に I フレームが複数存在するときは異なる値になる。
	

使用例
	faad infile.aac
		AAC のデコード infile.wav が出力される。

	faad infile.mp4
		MP4 コンテナ AAC 音声のデコード infile.wav が出力される。

	faad infile.ts
		TS 中の AAC 音声のデコード "infile PID xxx DELAY 0ms.wav" が出力される。

	faad -o outfile.wav infile.aac
		AAC のデコード outfile.wav が出力される。

	faad -w infile.aac > outfile.wav
		AAC のデコード outfile.wav が出力される。

	faad -a outfile.aac infile.aac
		ADTS AAC 出力 outfile.aac が出力される。


DGIndexを利用してTSからデコードする場合以下の様にメモ帳で書いて tsdec.cmd など .cmd か .batとして保存すると
D&Dでデコードできます(一度に1つまで)。"C:\略\DGIndex.exe" "faad.exe"は環境により変えてください。
-OFを-OFDに変えると .m2v出力です。


"C:\Program files\DGIndex\DGIndex.exe" -IF=[%~1] -OF=[%~dpn1] -EXIT
for %%A in ("%~dpn1*.aac") do "faad.exe" "%%A"
pause


DGIndex から出力される AAC を利用しない場合

"C:\Program files\DGIndex\DGIndex.exe" -IF=[%~1] -OF=[%~dpn1] -EXIT
"faad.exe" --pts-base 3 "%1"
pause


履歴
0.7
・TS 中の AAC の読み込みに対応
・サンプリングレートの変更を検出するようにした
・HE AAC デコード時、不要なエラーメッセージが出ないよう修正
・その他修正


0.6
・大幅に書き直し 安定性の向上(多分)
・-E オプション(部分的デコード)を追加
・-F オプション(種々の細かな制御)を追加
・最初の1フレームを破棄するように変更 (-E 1:0 をデフォルトにした)
　faad オリジナル互換です。オリジナルでは最初のフレームは 0 サンプルとなり破棄されます。
　-E 0:0 で従来同様最初のフレームを無音で出力します。
　DGIndex での DELAY値は、ソースコードを見る限り最初のフレームの AudioPTS と VideoPTS
　の差を求めているので、最初のフレームを破棄しない方が正しいように思いますが、詳しく
　ないのでよくわかりません。破棄した方が Video と合うらしいです。
　どちらが適当かは状況によるので適宜選択してください。
　特に ADTS 出力 (-a) の時注意してください。
・最初のフレームがエラーの時もユーザーにフォーマットについて尋ねないようにした
・崩れたフレームの Syncword 検索時、飛ばすのを最近接の Syncword になるよう修正
　(少し先の Syncword まで飛ばしていた)
・メッセージ変更 (フレーム番号を0からに変更、ディレイ調整のメッセージ追加 等)
・最終フレームが欠落している(ヘッダのフレーム長より残りバイト数が少ない)ときも
　取り敢えずデコードしてみるように変更
・その他修正

0.5
・faad2 v2.7のソースコードをマージ。
　(v2.6.1 と v2.7 ではフロントエンド部分には大きな変化はありません。
　バッファのサイズチェックなどが加わっています。
　0.5 に v2.6.1 の DLL、0.4 以前に v2.7 の DLL でも動作すると思います。)
・ファイル名に DELAY Xms があると -o でファイル名が指定できないバクを修正。
　(-D でディレイが指定されていないときに発生しました。)
　(ソフトウェア総合スレ6 361氏 レポートありがとうございます。)

0.4
・二重音声がデコードできなくなっていたのを修正。
・-S オプションでモノラル‐ステレオなどの ch 変化でも分割できるようにした。
　(フレームヘッダのchannelが変わる部分で分割)
・2ch-5.1ch分割時 1frame エラーしていたのを修正。
・ファイル名からディレイ補正した時ファイル名を DELAY 0ms に変更。
　(そのままの方が良い場合は -o <filename.wav>と出力ファイル名を指定してください)
・その他修正

0.3
・最初のフレームからエラーが出るとゼロ除算が生じるのを修正。
　チャンネル数とサンプリングレートが分からないので手動で指定してください。
　(ソフトウェアスレ4 382氏 レポートありがとうございます)
・ADTS出力 -a <filename> の改善。
　入力がADTSの場合、フレームヘッダを新しく作成せずバイパスして出力するようにしました。
　(もともとはADIFをADTSに変化する機能でADTSを読みこませても無意味なのですが、
　 ADTS出力時も分割するようにしたので、2ch と 5.1ch のAACの分割に利用できるはずです。)

0.2
・2ch から 5.1ch に切り替わった時、分割されずにダウンミックスされていたのを分割するように修正。
 （-d で ダウンミックスして単一のファイルを生成）
　(faad2 は 1ch AACを 2ch にアップミックスしてデコードするようなので 1ch <-> 2chは分割していません。)
・エラー耐性強化。フレームが崩れていても Syncword を検索するようにした。
　Syncwordを見つけるまでに飛ばしたバイト数分の Frame に相当する空白のファイルを生成します。
・その他修正

0.1
・エラー時、無音で埋めていなかったのを修正
・最後のフレームが途中で欠落している場合のメッセージを変更
・その他メッセージ変更
